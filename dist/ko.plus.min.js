/*=============================================================================
 *   Author:      Steve Greatrex - @stevegreatrex                               
 *                                                                              
 *   Description: Awesome extensions for KnockoutJs                              
 *=============================================================================*/

!function(a,b){"use strict";!function(b){"function"==typeof define&&define.amd?define("ko.plus",["jquery","knockout"],b):b(a.jQuery,a.ko)}(function(a,c){function d(b,c,d){var e=a.Deferred();return b?e.resolveWith(d,[c]):e.rejectWith(d,[c]),e}function e(a){return a&&a.then}function f(a,d){function e(){return!a.isEditing()&&(!a.isEditable||c.unwrap(a.isEditable()))}var f,g=[];return d=d||function(a){return a()},a.isEditing=c.observable(!1),a.beginEdit=function(){e()&&(f=b,g.push(d(a)),a.isEditing(!0))},a.endEdit=function(){a.isEditing()&&a.isEditing(!1)},a.cancelEdit=function(){a.isEditing()&&g.length&&(f=d(a),a(g.pop()),a.isEditing(!1))},a.undoCancel=function(){if(f!==b){var c=f;a.beginEdit(),a(c),f=b}},a.rollback=function(){g.length&&(f=b,a(g.pop()))},a.isDirty=c.computed(function(){return a.isEditing()&&JSON.stringify(g[g.length-1])!==JSON.stringify(c.unwrap(a))}).extend({throttle:1}),a}c.command=function(a){if("function"==typeof a&&(a={action:a}),!a)throw"No options were specified";if(!a.action)throw"No action was specified in the options";var b=c.observable(!1),f=c.observable(),g=c.observable(""),h=c.observable(!1),i={done:[],fail:[function(){f(!0)}],always:[function(){b(!1)},function(){h(!0)}]},j=function(){b(!1),f(!1),g("")},k=function(){if(!m.call(a.context||this))return d(!1,null,a.context||this).promise();b(!0),f(!1),g("");var c;try{c=a.action.apply(a.context||this,arguments),e(c)||(c=d(!0,c,a.context||this).promise())}catch(h){c=d(!1,h,a.context||this).promise()}return i.always.forEach(function(a){c.then(a,a)}),i.fail.forEach(function(a){c.then(null,a)}),i.done.forEach(function(a){c.then(a)}),c},l=c.observable(),m=a.canExecute||function(){return!0},n=c.computed({deferEvaluation:!0,read:function(){return l(),!b()&&m.call(a.context||this)}},a.context||this),o=function(){l.notifySubscribers()},p=function(a){return i.done.push(a),k},q=function(a){return i.fail.push(function(){var b=a.apply(this,arguments);b&&g(b)}),k},r=function(a){return i.always.push(a),k},s=function(a,b){return a&&i.done.push(a),b&&i.fail.push(b),k};return a.done&&i.done.push(a.done),a.fail&&i.fail.push(a.fail),k.isRunning=b,k.canExecute=n,k.canExecuteHasMutated=o,k.done=p,k.fail=q,k.then=s,k.failMessage=g,k.always=r,k.failed=f,k.completed=h,k.reset=j,k},c.bindingHandlers.command={init:function(a,b,d,e,f){var g=c.unwrap(b());c.bindingHandlers.loadingWhen.init.call(this,a,g.isRunning,d),c.bindingHandlers.click.init.call(this,a,c.observable(g),d,e,f)},update:function(a,b,d){var e=c.unwrap(b());c.bindingHandlers.loadingWhen.update.call(this,a,e.isRunning,d),c.bindingHandlers.enable.update.call(this,a,e.canExecute,d)}},c.editable=function(a){return f(c.observable(a))},c.editableArray=function(a){return f(c.observableArray(a||[]),function(a){return a.slice()})};var g={isDirty:!0,beginEdit:!0,cancelEdit:!0,undoCancel:!0,endEdit:!0,rollback:!0,isEditing:!0},h=function(a,b){for(var d in a)if(a.hasOwnProperty(d)&&!g[d]){var e=a[d];e&&e.isEditing&&b(e);var f=c.unwrap(e);if(f&&f.length&&"string"!=typeof f)for(var h=0;h<f.length;h++)f[h]&&f[h].isEditing&&b(f[h])}};return c.editable.makeEditable=function(a){if(!a)throw"Target must be specified";return a.isEditing=c.observable(!1),a.beginEdit=function(){(!a.isEditable||a.isEditable())&&(h(a,function(a){a.beginEdit()}),a.isEditing(!0))},a.endEdit=function(){h(a,function(a){a.endEdit()}),a.isEditing(!1)},a.cancelEdit=function(){h(a,function(a){a.cancelEdit()}),a.isEditing(!1)},a.rollback=function(){h(a,function(a){a.rollback()})},a.undoCancel=function(){h(a,function(a){a.undoCancel()}),a.beginEdit()},a.isDirty=c.computed(function(){var b=!1;return h(a,function(a){b=c.unwrap(a.isDirty)||b}),b}).extend({throttle:1}),a},c.extenders.editable=function(a){return f(a)},function(a,b,c){b.extenders.sortable=function(a,d){function e(a,c){function d(a,c){return a?(b.isObservable(a[c])&&i.push(a[c].subscribe(h)),b.unwrap(a[c])):null}return c.split(".").reduce(d,a)}function f(b,c){var d=a.sortDescending(),e=(a.sortKey()||"").split(","),f=0;return e.forEach(function(a){f=f||g(b,c,a.trim(),d)}),f}function g(a,b,f,g){var h=f?e(a,f):a,i=f?e(b,f):b;return null===h||h===c?null===i||i===c?0:d.sortNullsToBottom||g?1:-1:null===i||i===c?d.sortNullsToBottom||g?-1:1:("string"==typeof h&&(h=h.toLowerCase()),"string"==typeof i&&(i=i.toLowerCase()),i>h?g?1:-1:h>i?g?-1:1:0)}function h(){j||(i.forEach(function(a){a.dispose()}),i=[],j=!0,a.sort(f),j=!1)}"object"!=typeof d&&(d={});var i=[];a.sortKey=b.observable(d.key),a.sortDescending=b.observable(!!d.descending),a.setSortKey=function(b){b===a.sortKey()?a.sortDescending(!a.sortDescending()):(a.sortKey(b),a.sortDescending(!1))},a.sort(f);var j;return a.subscribe(h),a.sortKey.subscribe(h),a.sortDescending.subscribe(h),a},b.bindingHandlers.sortBy={init:function(c,d){function e(){i.css("display",g.sortKey()===h?"inline-block":"none"),g.sortDescending()?i.css({transform:"rotate(0)"}):i.css({transform:"rotate(180deg)"})}var f=b.unwrap(d());if(f){var g=f.source,h=b.unwrap(f.key);if(g&&h&&g.sortKey){var i=a("<span>").addClass("sort-caret");a(c).css({position:"relative"}).append(i).click(function(){g.setSortKey(h),e()}),g.sortKey.subscribe(e),g.sortDescending.subscribe(e),e()}}}}}(a,c),c.bindingHandlers.loadingWhen={init:function(b,d,e){var f=a(b),g=f.css("position"),h=c.unwrap(e()).loaderClass||f.attr("data-loader-class")||"loader-white",i=a("<span>",{"class":h}).addClass("loader").hide();f.append(i),("auto"===g||"static"===g)&&f.css("position","relative")},update:function(b,d){var e=c.unwrap(d()),f=a(b),g=f.children(":not(span.loader)"),h=f.children("span.loader");e?(g.css("visibility","hidden").attr("disabled","disabled"),h.stop(!0,!0).show()):(h.fadeOut("fast"),g.css("visibility","visible").removeAttr("disabled"))}},c})}(window);